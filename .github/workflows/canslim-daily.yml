name: CAN SLIM Daily Scan

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 09:00 (UTC 01:00)
    - cron: '0 1 * * *'
  workflow_dispatch:
    inputs:
      stock_count:
        description: 'æ‰«æè‚¡ç¥¨æ•°é‡'
        required: false
                default: '100'
        type: string

env:
  PYTHON_VERSION: '3.10'

jobs:
  scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
          uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Cache pip packages
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
                pip install yfinance>=0.2.40 pandas>=2.0.0 numpy>=1.24.0 requests>=2.31.0
        pip install akshare>=1.15.0 || echo "akshare install failed, continuing"
    
    - name: Run CAN SLIM Scanner
      id: scanner
      timeout-minutes: 30
      run: |
        mkdir -p reports
        python canslim_scanner.py --top ${{ github.event.inputs.stock_count || '100' }} --output reports/scan_$(date +%Y%m%d).json 2>&1 | tee reports/scan_$(date +%Y%m%d).log
      continue-on-error: true
      
    - name: Generate Markdown Report
      id: report
      run: |
        python << 'EOF'
                import json
        import os
        from datetime import datetime
        
        report_file = f"reports/scan_{datetime.now().strftime('%Y%m%d')}.json"
        md_file = f"reports/scan_{datetime.now().strftime('%Y%m%d')}.md"
        
        try:
            with open(report_file, 'r', encoding='utf-8') as f:
                data = json.load(f)
            
            stocks = data.get('stocks', [])
            scan_time = data.get('scan_time', datetime.now().isoformat())
            
            md_content = f"""# ðŸ“Š CAN SLIM æ¯æ—¥æ‰«ææŠ¥å‘Š
            **æ‰«ææ—¶é—´:** {scan_time}
**è‚¡ç¥¨æ± :** ç¾Žè‚¡ TOP100
**ç­–ç•¥:** æ¬§å¥ˆå°” CAN SLIM æˆé•¿è‚¡ç­›é€‰

---

## ðŸ† TOP 10 æŽ¨èè‚¡ç¥¨

| æŽ’å | ä»£ç  | å…¬å¸åç§° | æ€»åˆ† | C | A | N | S | L | I | M |
|------|------|----------|------|---|---|---|---|---|---|---|
"""
            
            for i, stock in enumerate(stocks[:10], 1):
                dims = stock.get('dimensions', {})
                                md_content += f"| {i} | **{stock['ticker']}** | {stock.get('name', '-')} | **{stock['total_score']}** | {dims.get('C', 0)} | {dims.get('A', 0)} | {dims.get('N', 0)} | {dims.get('S', 0)} | {dims.get('L', 0)} | {dims.get('I', 0)} | {dims.get('M', 0)} |\\n"
            
            md_content += """
---

*æŠ¥å‘Šç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*
*å…è´£å£°æ˜Ž: æœ¬æŠ¥å‘Šä»…ä¾›å‚è€ƒï¼Œä¸æž„æˆæŠ•èµ„å»ºè®®*
"""
            
            with open(md_file, 'w', encoding='utf-8') as f:
                f.write(md_content)
            
            print(f"æŠ¥å‘Šå·²ç”Ÿæˆ: {md_file}")
            
        except Exception as e:
                    print(f"ç”ŸæˆæŠ¥å‘Šæ—¶å‡ºé”™: {e}")
            with open(md_file, 'w', encoding='utf-8') as f:
                f.write(f"# CAN SLIM æ‰«ææŠ¥å‘Š\\n\\n**çŠ¶æ€:** éƒ¨åˆ†æ•°æ®èŽ·å–å¤±è´¥\\né”™è¯¯: {str(e)}")
        EOF
        
    - name: Upload Reports
      uses: actions/upload-artifact@v4
      with:
        name: canslim-reports-${{ github.run_id }}
        path: reports/
        retention-days: 30
        
    - name: Send to Discord
      if: ${{ success() }}
      env:
              DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
      run: |
        if [ -n "$DISCORD_WEBHOOK" ]; then
          curl -H "Content-Type: application/json" \
               -X POST \
               -d "{\"content\": \"ðŸ“Š CAN SLIM æ¯æ—¥æ‰«æå®Œæˆ - $(date +%Y-%m-%d)\\næŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"}" \
               $DISCORD_WEBHOOK
        else
          echo "æœªé…ç½® DISCORD_WEBHOOK_URLï¼Œè·³è¿‡æŽ¨é€"
        fi
        
    - name: Commit Reports
      if: ${{ success() }}
      run: |
        git config --local user.email "action@github.com"
                git config --local user.name "GitHub Action"
        mkdir -p reports
        git add reports/
        git diff --staged --quiet || (git commit -m "ðŸ“Š CAN SLIM æ¯æ—¥æ‰«ææŠ¥å‘Š - $(date +%Y-%m-%d)" && git push) || echo "æ— æ›´æ”¹éœ€è¦æäº¤"
